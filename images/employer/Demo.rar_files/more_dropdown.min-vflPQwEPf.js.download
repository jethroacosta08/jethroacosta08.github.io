define(["require","exports","tslib","react","external/lodash","external/react-redux","spectrum/popover","modules/clean/previews/data/selectors","modules/clean/previews/util","modules/clean/react/bubble_dropdown_v2","modules/clean/react/file_action_button_type","modules/clean/react/file_viewer/logging","modules/clean/react/file_viewer/constants","modules/clean/react/file_viewer/data/selectors","file-viewer/core","modules/clean/react/file_viewer/files2_utils","modules/clean/react/file_viewer/utils","modules/clean/react/file_viewer/more_dropdown/models","modules/clean/react/file_viewer/more_dropdown/more_option_registry","modules/clean/react/file_viewer/more_dropdown/views","modules/clean/react/size_class/constants","modules/clean/file_store/utils","modules/clean/react/title_bar/overflow_menu","modules/core/browser","modules/core/i18n","react-dom","modules/clean/react/file_viewer/data/actions","modules/clean/previews/util","modules/clean/react/extensions/download_intercept","modules/clean/react/extensions/data/action_creators","modules/clean/react/watermarking/callout","modules/clean/react/watermarking/utils","modules/clean/react/size_class/utils","modules/clean/react/file_viewer/callout_utils"],function(e,t,o,r,n,i,l,a,s,c,u,d,p,m,f,g,_,v,h,w,C,k,A,M,y,b,S,F,I,D,O,E,B,R){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),r=o.__importDefault(r),n=o.__importStar(n),s=o.__importStar(s),b=o.__importStar(b);var T=(function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.state=t.getStateFromRegistry(),t.onRegistryUpdate=function(){t.setState(t.getStateFromRegistry())},t.handleDownloadClick=function(e){e.preventDefault(),S.download(t.props.file);var o=t.props.setInDownloadInterceptFlow;if(t.props.extensionsConfig&&k.isBrowseFile(t.props.file)&&t.props.user&&o&&t.props.sizeClass===C.SizeClass.Large){var r=function(){o({inDownloadInterceptFlow:!0})};I.onDownloadFile(t.props.extensionsConfig,t.props.user,t.props.file.ext,r)}return d.logUserAction(p.UserAction.Download,p.UserActionContext.TitleBarMore)},t.handleRemoveLinkClick=function(e){e.preventDefault(),t.props.onRemoveShareLink&&(t.props.onRemoveShareLink(),d.logUserAction(p.UserAction.RemoveLink,p.UserActionContext.TitleBarMore))},t.handlePreviousVersionClick=function(e){if(e.preventDefault(),!t.props.user)throw new Error("User not specified");return s.redirectToVersionHistory(t.props.file,t.props.user),d.logUserAction(p.UserAction.ViewRevisions,p.UserActionContext.TitleBarMore)},t.handleSignInClick=function(e){e.preventDefault(),d.logUserAction(p.UserAction.SignIn,p.UserActionContext.TitleBarMore),M.redirect(_.getSharedLinkLoginUrl())},t.handleWatermarkingModeToggle=function(e){return o.__awaiter(t,void 0,void 0,function(){var t,r,n;return o.__generator(this,function(o){return e.preventDefault(),t=this.props,r=t.mode,(n=t.changeMode)?(r===f.FileViewerMode.Watermarking?(d.logUserAction(p.UserAction.WatermarkCancel,p.UserActionContext.TitleBarMore),n(f.FileViewerMode.Default)):(d.logUserAction(p.UserAction.WatermarkEnable,p.UserActionContext.TitleBarMore),n(f.FileViewerMode.Watermarking)),[2]):[2]})})},t.handleClick=function(){t.setState({hasBeenClicked:!0})},t}return o.__extends(t,e),t.prototype.componentDidMount=function(){this.removeRegistryListener=h.moreOptionRegistry.addListener(this.onRegistryUpdate)},t.prototype.componentWillUnmount=function(){this.removeRegistryListener()},t.prototype.getStateFromRegistry=function(){var e=this.state||{hasBeenClicked:!1,registeredItems:[]},t=o.__assign({},e,{registeredItems:h.moreOptionRegistry.getOptionItems()}),r=this.getOptionItemsContent(t.registeredItems),i=this.getOptionItemsContent(e.registeredItems);return n.isEqual(r,i)||(t.hasBeenClicked=!1),t},t.prototype.getOptionItemsContent=function(e){var t=this;return e.reduce(function(e,o){return o instanceof v.MoreOption?e.push(t.getMoreOptionContent(o)):e=e.concat(o.options.map(t.getMoreOptionContent)),e},[])},t.prototype.getMoreOptionContent=function(e){return u.getFileActionButtonText(e.fileActionButtonType)},t.prototype.getPopoverContent=function(){var e=this.props,t=e.allowRemoveLink,o=e.isPrivate,n=e.mode,i=e.onRemoveShareLink,a=e.renderSignIn,s=e.shareDownloadOptions,c=e.sizeClass,d=e.file,p=e.user,m=[],_=c===C.SizeClass.Small,v=c===C.SizeClass.Medium,h=!B.isSmallerThanLarge(c);if(o&&v&&m.push(r.default.createElement(A.PopoverOrMobileItem,{className:"more-button__share",key:"more-button__share",onSelect:this.props.onClickShareLink},u.getFileActionButtonText(u.FileActionButtonType.SHARE))),null!=i&&t&&!_&&m.push(r.default.createElement(A.PopoverOrMobileItem,{className:"more-button__remove",key:"more-button__remove",onSelect:this.handleRemoveLinkClick},u.getFileActionButtonText(u.FileActionButtonType.REMOVE_LINK))),o&&!F.isCloudDocPreview(d)&&m.push(r.default.createElement(A.PopoverOrMobileItem,{className:"more-button__download",key:"more-button__download",onSelect:this.handleDownloadClick},u.getFileActionButtonText(u.FileActionButtonType.DOWNLOAD))),s&&!F.isCloudDocPreview(d))for(var k=0,M=s;k<M.length;k++){var b=M[k];if(!b.isDisabled){var S="more-button-sl__"+b.userAction;m.push(r.default.createElement(P,{handler:b.handler,key:S,text:b.text,userAction:b.userAction}))}}if(o&&!_&&m.push(r.default.createElement(A.PopoverOrMobileItem,{className:"more-button__version-history",key:"more-button__version-history",onSelect:this.handlePreviousVersionClick},u.getFileActionButtonText(u.FileActionButtonType.PREVIOUS_VERSIONS))),h&&!F.isCloudDocPreview(d)){var I=w.getPopoverOrMobileItemsForMoreOptions(this.state.registeredItems);m=m.concat(I)}if(!g.isFiles2WatermarkingEnabled(p)&&E.allowWatermark(d,p)){m.push(r.default.createElement(l.PopoverContentSeparator,{key:"more_button__separator2"}));var D=n===f.FileViewerMode.Watermarking?u.FileActionButtonType.REMOVE_WATERMARKING:u.FileActionButtonType.ENABLE_WATERMARKING;m.push(r.default.createElement(A.PopoverOrMobileItem,{className:"more-button__watermarking-toggle",key:"more-button__watermarking-toggle",onSelect:this.handleWatermarkingModeToggle},u.getFileActionButtonText(D)))}return a&&m.push(r.default.createElement(A.PopoverOrMobileItem,{className:"more-button__sign-in",key:"more-button__sign-in",onSelect:this.handleSignInClick},F.isCloudDocPreview(d)?y._("Edit now"):y._("Sign in"))),m},t.prototype.render=function(){var e=this,t=this.props,o=t.file,n=t.user,i=this.state.hasBeenClicked;return r.default.createElement("div",{ref:function(t){e.ref=b.findDOMNode(t)},onClick:this.handleClick},r.default.createElement(A.OverflowMenu,{contentWrapperClassName:"react-file-viewer-dropdown",hideOnDisabled:F.isCloudDocPreview(o)},this.getPopoverContent()),g.isFiles2WatermarkingEnabled(n)||!E.allowWatermark(o,n)||R.isPromptCalloutEnabled()?null:r.default.createElement(O.WatermarkingCallout,{targetNode:this.ref,parentHasBeenClicked:i,position:c.BubbleDropdownPositions.BOTTOM_LEFT}))},t})(r.default.Component);t._MoreDropdown=T;var x=function(e){var t=m.getActiveFile(e);return{isFileRendered:m.getRenderStatusForCurrentFile(e)===p.PreviewRenderStatus.Succeeded,mode:m.getMode(e),previewApiData:a.getApiDataForFile(e,t)}},U=i.connect(x,{changeMode:S.changeMode,setInDownloadInterceptFlow:D.setInDownloadInterceptFlow})(T);t.MoreDropdown=U;var P=(function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.handleClick=function(){var e=t.props,o=e.handler,r=e.userAction;d.logUserAction(r,p.UserActionContext.TitleBarMore),o()},t}return o.__extends(t,e),t.prototype.render=function(){var e=this.props.text;return r.default.createElement(A.PopoverOrMobileItem,{onSelect:this.handleClick},e)},t})(r.default.PureComponent)});
//# sourceMappingURL=more_dropdown.min.js-vflYyxzT3.map
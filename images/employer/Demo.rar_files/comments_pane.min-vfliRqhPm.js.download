define(["require","exports","tslib","react","external/react-redux","modules/clean/account/email","modules/clean/account/email_verify_reasons","modules/clean/react/css","external/classnames","modules/core/i18n","modules/clean/auth/login_or_register/types","modules/clean/react_format","external/lodash","modules/constants/file_viewer","spectrum_comments/comment","spectrum_comments/comment_editor","spectrum_comments/comment_stream","spectrum_comments/coachmark_location","spectrum_comments/utils/guest_utils","modules/clean/react/comments2/actions_adapters/index","modules/clean/react/comments2/components/onboarding","modules/clean/react/comments2/components/coachmark","modules/clean/react/comments2/components/sidebar_listener","modules/clean/react/comments2/components/util","modules/clean/react/comments2/util","modules/clean/react/comments2/data/logger","modules/clean/react/comments2/data/types","modules/clean/react/comments2/transforms","modules/clean/react/comments2/data/actions","modules/clean/react/file_viewer/data/selectors","modules/clean/react/comments2/data/selectors","modules/clean/react/comments2/data/perf_util","modules/clean/react/comments2/data/mentions_api","modules/clean/previews/constants","modules/clean/react/comments2/components/comments_translations","modules/clean/react/comments2/components/tooltips","modules/clean/sharing/actions/sharing_actions","modules/clean/react/file_viewer/callout_utils"],function(e,t,n,o,a,r,i,s,m,l,c,d,p,u,_,g,h,f,v,b,w,T,E,y,C,S,M,A,P,O,k,I,D,U,x,N,V,R){"use strict";function F(e,t){return void 0===t&&(t=1),e===U.PreviewType.SsrDoc?{type:"document",regionType:"rectangle",regions:[{page:t,x:0,y:0,width:1,height:1}]}:{type:"image",region:{x:0,y:0,width:1,height:1}}}function L(e){var t=e.currentPageIndex,a=void 0===t?0:t,r=e.disabledTimeCodeTooltipComponent,i=e.playerCurrentTime,s=void 0===i?0:i,m=e.pendingNumberedAnnotation,l=e.playerIntegrationEnabled,c=e.previewType,d=e.upsellTooltipComponent;if(c===U.PreviewType.Audio||c===U.PreviewType.Video){var p=void 0;d?p=d:l||(p=r);var u=c===U.PreviewType.Audio?"audio":"video";return o.default.createElement(g.TimeCodedCommentEditor,n.__assign({},e,{pendingAnnotation:{type:u,time:s},tooltipComponent:p}))}return c===U.PreviewType.SsrDoc||c===U.PreviewType.Image?o.default.createElement(g.NumberedCommentEditor,n.__assign({},e,{defaultAnnotation:F(c,a+1),pendingAnnotation:m})):o.default.createElement(g.CommentEditor,n.__assign({},e))}Object.defineProperty(t,"__esModule",{value:!0}),o=n.__importDefault(o),a=n.__importStar(a),i=n.__importStar(i),m=n.__importDefault(m),p=n.__importStar(p),S=n.__importStar(S),k=n.__importStar(k),I=n.__importStar(I);var q=["image_preview_surface","document_preview_surface","how_to_at_mention_comments_pane_surface"],K=function(e){var t=e.children,n=e.markOnboarded,a=e.playerIntegrationEnabled,r=e.previewType,i=e.showOnboarding,s=a?"target-annotation":"target-mention",m=r!==U.PreviewType.Image&&r!==U.PreviewType.SsrDoc;return o.default.createElement(g.CoachMarkContainer,{className:s},t,m&&i&&!R.isPromptCalloutEnabled()&&o.default.createElement(w.CoachMark,{markOnboarded:n,playerIntegrationEnabled:a,previewType:r}))},Q=(function(t){function a(a){var s=t.call(this,a)||this;return s.mentionsQueryId=0,s.onCommentStreamRef=function(e){return s.commentStream=e},s.updateMentionsMatches=function(e){s.setState({mentionsMatches:e})},s.logMentionsQueryCompletedPerf=function(e){var t=I.mentionsQueryCompleted();s.props.dispatch(P.Actions.logPerfEvent(t,e))},s.onMentionsQueryUpdated=function(e){if(e){var t=++s.mentionsQueryId;s.mentionsApi.query(e,s.updateMentionsMatches,I.withTiming(s.updateMentionsMatches,function(e){s.mentionsQueryId===t&&s.logMentionsQueryCompletedPerf(e)}))}else""===e&&s.updateMentionsMatches(s.mentionsApi.getMatchesWithStarterSuggestions());s.props.dispatch(P.Actions.markOnboardedIfUnmarked("how_to_at_mention_comments_pane_surface"))},s.onPostSuccess=function(e,t){e.metadata&&e.metadata.some(function(e){return"mention"===e.type})&&V.SharingActions.listMembers({user:t,contentId:s.props.stream.id,isFolder:!1,url:s.props.stream.linkUrl,includeSeenState:!1})},s.showEmailVerifyModal=function(e){if(!s.props.hasShownAnyModalVariant||e!==M.ShowModalReason.EditorFocus){s.props.dispatch(P.Actions.markModalVariantShown(M.ModalVariant.EmailVerifyModal)),S.logEvent("email_verify_modal_shown",{stream:s.props.stream});var t=function(){S.logEvent("email_verify_flow_completed",{stream:s.props.stream})};r.EmailVerification.get_for_user(s.props.viewer).show_verify_modal(t,i.ADD_COMMENT)}},s.showSignUpModal=function(t){if((!s.props.hasShownAnyModalVariant||t!==M.ShowModalReason.EditorFocus)&&u.SHARED_LINK_REACT_AUTH_MODAL){var a=function(){return n.__awaiter(s,void 0,void 0,function(){var t,a,r,i,s=this;return n.__generator(this,function(m){switch(m.label){case 0:return[4,Promise.all([new Promise(function(t,n){e(["modules/clean/react/modal"],t,n)}).then(n.__importStar),new Promise(function(t,n){e(["modules/clean/auth/login_or_register/modal"],t,n)}).then(n.__importStar),new Promise(function(t,n){e(["modules/core/browser"],t,n)}).then(n.__importStar)])];case 1:return t=m.sent(),a=t[0].Modal,r=t[1].LoginOrRegisterModal,i=t[2],S.logEvent("sign_up_modal_shown",{stream:this.props.stream}),a.showInstance(o.default.createElement(r,{commentParams:{stream:this.props.stream,variant:c.CommentTextVariant.POST},downloadAction:null,id:"shared-link-default-comments-signup-modal",kind:c.LoginOrRegisterKind.COMMENT,onAuthenticateSuccess:function(){return i.reload()},onCancel:function(){return S.logEvent("sign_up_modal_dismissed",{stream:s.props.stream})},showAppleLogin:!1,signup_tag:"comments_shmodel_modal_register"})),[2]}})})};s.props.dispatch(P.Actions.markModalVariantShown(M.ModalVariant.SignUpModal)),a()}},s.dismissImagePreviewSurfaceOnboarding=function(){s.dismissOnboarding(),s.markOnboarded("image_preview_surface")},s.dismissDocumentPreviewSurfaceOnboarding=function(){s.dismissOnboarding(),s.markOnboarded("document_preview_surface")},s.dismissHowToAtMentionOnoarding=function(){s.dismissOnboarding(),s.markOnboarded("how_to_at_mention_comments_pane_surface")},s.createComment=function(e){switch(s.props.previewType){case U.PreviewType.Video:case U.PreviewType.Audio:return o.default.createElement(_.TimeCodedComment,n.__assign({},e,{playerIntegrationEnabled:s.props.playerIntegrationEnabled}));case U.PreviewType.Image:case U.PreviewType.SsrDoc:return o.default.createElement(_.NumberedComment,n.__assign({},e));default:return o.default.createElement(_.Comment,n.__assign({},e))}},s.createEditor=function(e){var t=s.props,a=t.currentPageIndex,r=t.pendingNumberedAnnotation,i=t.playerCurrentTime,m=t.playerIntegrationEnabled,l=t.previewType,c=t.showOnboarding,d=t.upsellTooltipVariant,p=d?s.createUpsellTooltip:void 0;return o.default.createElement(K,{markOnboarded:s.markOnboarded,playerIntegrationEnabled:m,previewType:l,showOnboarding:c},o.default.createElement(L,n.__assign({},e,{disabledTimeCodeTooltipComponent:s.createDisabledTimeCodeTooltip,upsellTooltipComponent:p,pendingNumberedAnnotation:r,currentPageIndex:a,playerIntegrationEnabled:m,playerCurrentTime:i,previewType:l})))},s.createDisabledTimeCodeTooltip=function(e){return o.default.createElement(N.DisabledTimeCodeTooltip,n.__assign({},e,{onClick:s.onDisabledTooltipLearnMoreClick,onShow:s.onDisabledTooltipShow}))},s.createUpsellTooltip=function(e){return o.default.createElement(N.UpsellTooltip,n.__assign({},e,{onClick:s.onUpsellTooltipClick,onDismiss:s.onUpsellTooltipDismiss,onShow:s.onUpsellTooltipShow,variant:s.props.upsellTooltipVariant,showUpsellExperiment:!s.props.collapsed&&s.props.showUpsellExperiment}))},s.onDisabledTooltipLearnMoreClick=function(){return s.props.dispatch(P.Actions.logEvent("time_based_tooltip_learn_more_click"))},s.onDisabledTooltipShow=function(){return s.props.dispatch(P.Actions.logEvent("time_based_tooltip_learn_more_view"))},s.onUpsellTooltipClick=function(){s.dismissUpsell(),s.props.dispatch(P.Actions.logEvent("time_based_tooltip_upgrade_click"))},s.onUpsellTooltipDismiss=function(){s.dismissUpsell(),s.props.dispatch(P.Actions.logEvent("time_based_tooltip_upgrade_dismiss"))},s.onUpsellTooltipShow=function(){return s.props.dispatch(P.Actions.logEvent("time_based_tooltip_upgrade_view"))},s.markOnboarded=function(e){s.props.dispatch(P.Actions.markOnboarded(e))},s.dismissOnboarding=function(){s.props.dispatch(P.Actions.dismissOnboarding(null))},s.mentionsApi=D.mentionsApi(a.viewer),s.state={mentionsMatches:s.mentionsApi.cache},s}return n.__extends(a,t),a.prototype.componentDidMount=function(){var e=this.props,t=e.dispatch,n=e.showOnboarding,o=e.perfEvents,a=+new Date;t(P.Actions.logEvent("show_comments")),t(P.Actions.logSimplePerfEvent("stream_displayed_ms",a-(o.listCompleteTime||0))),t(P.Actions.logSimplePerfEvent("comment_editor_tti_ms",a-(o.setContextTime||0))),n&&t(P.Actions.logEvent("sidebar_onboarding_shown"))},a.prototype.componentDidUpdate=function(e){var t=e.requestEditorFocus,n=e.showOnboarding,o=this.props,a=o.showOnboarding,r=o.dispatch,i=o.requestEditorFocus;!n&&a&&r(P.Actions.logEvent("sidebar_onboarding_shown")),!t&&i&&(this.commentStream.focusPrimaryEditor(),r(P.Actions.fulfillEditorFocusRequest()))},Object.defineProperty(a.prototype,"onboardingKeysToMarkOnThreadCreation",{get:function(){return p.difference(this.props.relevantOnboardingKeys,q)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"imagePdfCoachmarkData",{get:function(){var e=this;if(!R.isPromptCalloutEnabled()){var t=this.props,a=t.showOnboarding,r=t.relevantOnboardingKeys,i=l._("Animation of annotating a file",{comment:"This is alt text for an animated gif"}),s=a&&p.head(p.intersection(q,r)),m={title:o.default.createElement("h2",{className:"sc-coachmark-title"}),body:o.default.createElement("p",null)};switch(s){case"document_preview_surface":return{location:f.CoachmarkLocations.BELOW_COMMENT_STREAM,component:function(t){return o.default.createElement(T.CommentsCoachmark,n.__assign({},t,{overrideArrowPlacement:"left",onClose:e.dismissDocumentPreviewSurfaceOnboarding}),o.default.createElement(y.Comments2OnboardingImage,{fileNamePrefix:"02_Comments2_PDFComments","aria-label":i}),d.reactFormat(l._("<title>Call it out</title> <body>Select an area on the file to highlight and comment.</body>"),m))}};case"image_preview_surface":return{location:f.CoachmarkLocations.BELOW_COMMENT_STREAM,component:function(t){return o.default.createElement(T.CommentsCoachmark,n.__assign({},t,{overrideArrowPlacement:"left",onClose:e.dismissImagePreviewSurfaceOnboarding}),o.default.createElement(y.Comments2OnboardingImage,{fileNamePrefix:"01_Comments2_ImageComment","aria-label":i}),d.reactFormat(l._("<title>Call it out</title> <body>Select an area on the image to highlight and comment.</body>"),m))}};case"how_to_at_mention_comments_pane_surface":return{location:f.CoachmarkLocations.ABOVE_COMMENT_STREAM,target:f.CoachmarkTargets.MAIN_EDITOR_MENTION_BUTTON,component:function(t){return o.default.createElement(T.CommentsCoachmark,n.__assign({},t,{onClose:e.dismissHowToAtMentionOnoarding}),o.default.createElement(y.Comments2OnboardingImage,{fileNamePrefix:"03_Comments_AtMentions_v1","aria-label":l._("Animation of mentioning a user",{comment:"This is alt text for an animated gif"})}),d.reactFormat(l._("<title>Get the feedback you need</title> <body>Tag someone to work together on this file.</body>"),m))}};default:return}}},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"actionsAdapter",{get:function(){var e=this.props.fileSidebarDispatch;return b.createActionsAdapter(this.props,e,this.onboardingKeysToMarkOnThreadCreation,this.onMentionsQueryUpdated,this.onPostSuccess,this.showSignUpModal,this.showEmailVerifyModal)},enumerable:!0,configurable:!0}),a.prototype.dismissUpsell=function(){var e=C.inUpsellExperiment();this.props.showUpsellExperiment?this.props.dispatch(P.Actions.dismissUpsellExperiment(void 0)):e||this.props.dispatch(P.Actions.dismissUpsellTooltip(void 0))},a.prototype.stickerSetsToStickerPacks=function(e){return e.map(function(e){return{url:e.url,stickers:e.stickers,description:e.description,name:e.name,id:e.set_id}})},a.prototype.render=function(){var e,t=this.props,n=t.activeThreadId,a=t.collapsed,r=t.dispatch,i=t.editorIsEmpty,s=t.hoverThreadId,l=t.isMobile,c=t.showResolved,d=t.stream.id,p=t.threads,u=t.viewer,_=t.previewType,g=t.streamSettings,f=t.stickers,b=p.filter(function(e){return c||!e.resolvedInfo});e=u?A.dbxUserToIUser(u):v.getGuestIUser();var w=_===U.PreviewType.Image||_===U.PreviewType.SsrDoc;return o.default.createElement("div",{className:m.default("comments-pane-wrapper",{"no-comment":C.isComments2Mobile()&&0===b.length,"comments-pane-wrapper-show-resolved":c,"comments-pane-wrapper-hide-resolved":!c,"comments-pane-wrapper-all-changes-saved":!p.some(function(e){return!!e.pending})})},o.default.createElement(h.CommentStream,{ref:this.onCommentStreamRef,id:d,actionsAdapter:this.actionsAdapter,commentComponent:this.createComment,editorComponent:this.createEditor,enabled:!0,isMobile:l,mentionsMatches:this.state.mentionsMatches,settings:g,threads:b,user:e,activeThreadID:n,hoverThreadID:s,showUnreadPill:C.canShowUnreadPill(),localization:x.commentsMasterLocalization,collapsed:a,coachmarkData:this.imagePdfCoachmarkData,showRevisionInfo:w,stickerPacks:f&&this.stickerSetsToStickerPacks(f)}),o.default.createElement(E.SidebarListener,{dispatch:r,editorIsEmpty:i}))},a})(o.default.Component);t.CommentsPaneComponent=Q;var H=a.connect(function(e){var t=k.getContext(e),n=t.stream,o=t.viewer,a=k.getData(e),r=a.perfEvents,i=a.upsellExperimentNotDismissed,s=a.upsellTooltipVariant;return{activeThreadId:k.getActivatedThreadId(e),editorIsEmpty:k.getEditorIsEmpty(e),hasShownAnyModalVariant:k.getHasShownAnyModalVariant(e),hoverThreadId:k.getHoverThreadId(e),playerCurrentTime:k.getPlayerCurrentTime(e),playerIntegrationEnabled:k.getIsPlayerIntegrationEnabled(e),relevantOnboardingKeys:k.getUnmarkedOnboardingKeysRelevantToCurrentFile(e),showOnboarding:k.getShowOnboardingOnCommentsPane(e),showResolved:k.getShowResolved(e),canEnable:k.getCanEnable(e),isEnabled:k.isEnabled(e),canSubscribe:k.getCanSubscribe(e),isSubscribed:k.getIsSubscribed(e),pendingNumberedAnnotation:k.getPendingNumberedAnnotation(e),previewType:k.getPreviewTypeForCurrentFile(e),currentPageIndex:O.getCurrentPageIndex(e),showUpsellExperiment:C.inUpsellExperiment()&&i,stream:n,threads:k.getThreads(e),viewer:o,upsellTooltipVariant:s,perfEvents:r,requestEditorFocus:k.getIsEditorFocusRequested(e),streamSettings:k.getStreamSettings(e),stickers:k.getStickers(e)}})(Q);t.CommentsPane=s.requireCssWithComponent(H,["/static/js/spectrum_comments/index.web-vflyMCRAv.css","/static/css/comments2-vfl8XMT8c.css","/static/css/snackbar-vflNSHCgN.css"])});
//# sourceMappingURL=comments_pane.min.js-vflqfkAzw.map
define(["require","exports","tslib","external/classnames","react","external/prop-types","external/lodash","modules/clean/components/loading_indicator","modules/clean/loggers/pass_facepile_logger","modules/clean/react/css","modules/clean/react/pass/empty_seen_state_facepile","modules/clean/react/file_viewer/share_helpers","modules/clean/react/pass/constants","modules/clean/react/pass/event_emitter","modules/clean/react/pass/types","modules/clean/react/pass/avatars","modules/clean/react/pass/utils","modules/clean/viewer","modules/clean/react/size_class/constants","modules/clean/file_store/utils","modules/clean/sharing/constants","modules/core/i18n","modules/core/user_i18n","spectrum_comments/rich_facepile"],function(e,s,t,n,r,o,i,a,p,u,l,c,h,d,f,m,_,g,S,v,y,I,w,E){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),n=t.__importDefault(n),r=t.__importDefault(r),o=t.__importStar(o),i=t.__importStar(i),c=t.__importStar(c),w=t.__importStar(w);var C=(function(e){function s(){var s=null!==e&&e.apply(this,arguments)||this;return s.state={newPresentUserIds:[]},s.numUsersToLog=0,s.hasPassShownBeenLogged=!1,s.onAvatarHover=function(){return s.logPassEvent(h.EventTypes.PASS_HOVER)},s.openShareModal=function(){var e=s.props.fromBrowse?y.SHARE_ACTION_ORIGIN_TYPE.BROWSE_FILE_FACEPILE:y.SHARE_ACTION_ORIGIN_TYPE.PREVIEW_PAGE_FACEPILE;c.share(s.props.file,g.Viewer.get_viewer().get_user_by_id(s.props.user.id),s.props.url||null,e)},s.onTooltipChange=function(e,t){var n=e.activeMode,r=e.displayInfo,o=t.activeMode,i=t.displayInfo;!n&&o&&i===E.OVERFLOW?s.openShareModal():null!==i&&r!==i&&s.onAvatarHover()},s.localization={nOthers:function(e){return I.ungettext("%(display_num)s other","%(display_num)s others",e).format({display_num:e})},ninetyNinePlus:I._("99+")},s}return t.__extends(s,e),s.prototype.componentWillMount=function(){this.resetLogging(),p.passFacepileLogger.listenTo(d.passEventEmitter)},s.prototype.componentDidMount=function(){this.logFacepileShownEvents()},s.prototype.componentWillReceiveProps=function(e){if(v.areFilesEqual(this.props.file,e.file)){if(null==e.presence||null==this.props.presence)return;var s=i.difference(e.presence,this.props.presence),t=i.difference(this.props.presence,e.presence);this.updateNewPresentUserIds(s,t)}else this.setState({newPresentUserIds:[]}),this.resetLogging()},s.prototype.componentDidUpdate=function(e){this.logFacepileShownEvents()},s.prototype.componentWillUnmount=function(){p.passFacepileLogger.unlistenTo(d.passEventEmitter)},s.prototype.updateNewPresentUserIds=function(e,s){var t=i.filter(this.state.newPresentUserIds,function(e){return s.indexOf(e)===-1});this.setState({newPresentUserIds:e.concat(t)})},s.prototype.computeOverflowBasis=function(e){if(!this.props.uniqueMemberCountInfo.data)return e.length;var s=this.props.uniqueMemberCountInfo.data;return e.forEach(function(e){e.incrementOverflowBasis&&++s}),Math.max(s,e.length)},s.prototype.resetLogging=function(){this.numUsersToLog=0,this.hasPassShownBeenLogged=!1},s.prototype.logFacepileShownEvents=function(){if(this.props.presence&&!this.hasPassShownBeenLogged&&this.haveSeenStateDataToShow(this.getUserInfoList())){var e=h.EventTypes.PASS_SHOWN;this.logPassEvent(e),this.hasPassShownBeenLogged=!0}},s.prototype.logPassEvent=function(e){var s=null!=this.props.uniqueMemberCountInfo.data?Math.max(this.numUsersToLog,this.props.uniqueMemberCountInfo.data):this.numUsersToLog,t=this.props.passPermissions?this.props.passPermissions.canReadSeenState:null,n=this.props.anonymousPresenceInfo.length,r=this.getViewerCountByAccessLevel(),o=r.numViewers,i=r.numInTeamEditors,a=r.numInTeamViewers,p=r.numNonTeamEditors,u=r.numNonTeamViewers;return d.passEventEmitter.emit(e,this.props.fromBrowse,this.props.file,{numAccessors:s,numViewers:o,numCurrentViewers:this.getNumCurrentViewers(),canSeeViewerHistory:t,numGuests:n,numInTeamEditors:i,numInTeamViewers:a,numNonTeamEditors:p,numNonTeamViewers:u})},s.prototype.getViewerCountByAccessLevel=function(){var e,s,t=this,n=0,r=0,o=0,i=0;if(this.shouldHardcodeCurrentViewer()){s=this.seenStateDataWithViewerFiltered(this.getSeenStates());var a=this.getSeenStates().filter(function(e){return e.seen_state_user.user_id===t.props.user.account_id});if(a.length>0){e=0;var p=a[0];p.when_last_seen=1,s.push(p)}else e=1,n++}else e=0,s=this.getSeenStates();for(var u=0,l=s;u<l.length;u++){var c=l[u];if(null!=c.when_last_seen){e++;var h=c.seen_state_user;h.in_owners_team?h.sharing_access_type&&"edit_member_access"===h.sharing_access_type.type?n++:r++:h.sharing_access_type&&"edit_member_access"===h.sharing_access_type.type?o++:i++}}return{numViewers:e,numInTeamEditors:n,numInTeamViewers:r,numNonTeamEditors:o,numNonTeamViewers:i}},s.prototype.getNumCurrentViewers=function(){var e=this;if(!this.props.presence)return 0;if(this.shouldHardcodeCurrentViewer()){return 1+this.props.presence.filter(function(s){return s!==e.props.user.account_id}).map(function(e){return e}).length}return this.props.presence.length},s.prototype.userIsAnonymous=function(e){return i.map(this.props.anonymousPresenceInfo,function(e){return e.seen_state_user.user_id}).indexOf(e.user_id)>=0},s.prototype.userIsOnline=function(e){return null!=this.props.presence&&this.props.presence.indexOf(e.user_id)>=0},s.prototype.buildUserInfo=function(e){var s=e.seen_state_user,t=e.when_last_seen,n=e.platform_type,r=s.access_level,o=s.display_name,i=s.email,a=s.photo_circle_url,p=s.sharing_access_type,u=s.user_id,l=u||o,c=_.shouldIncrementOverflowBasisForAccessType(p);return new f.UserInfo(l,o,this.userIsOnline(s),!1,c,i,r,t,a,u,n)},s.prototype.seenStateDataWithViewerFiltered=function(e){var s=this;return i.filter(e,function(e){return e.seen_state_user.user_id!==s.props.user.account_id})},s.prototype.partitionUserInfoLists=function(e){for(var s=[],t=[],n=[],r=[],o=[],i={},a=0,p=e;a<p.length;a++){var u=p[a],l=this.buildUserInfo(u);this.userIsOnline(u.seen_state_user)?this.isNewPresentUser(l)?i[l.key]=l:this.userIsAnonymous(u.seen_state_user)?n.push(l):t.push(l):null!=u.when_last_seen?r.push(l):o.push(l)}for(var c=0,h=this.state.newPresentUserIds;c<h.length;c++){var d=h[c],l=i[d];l&&s.push(l)}return{newPresentUserInfoList:s,presentUserInfoList:t,anonymousUserInfoList:n,offlineUserInfoList:r,neverViewedUserInfoList:o}},s.prototype.getUserInfoList=function(){var e,s=[],t=this.getMergedSeenStateData();if(this.shouldHardcodeCurrentViewer()){e=this.seenStateDataWithViewerFiltered(t);var n=this.props.user.account_id,r=!this.props.fromBrowse&&e.length<t.length&&this.getSeenStates().some(function(e){var s=e.seen_state_user;return s.user_id===n&&_.shouldIncrementOverflowBasisForAccessType(s.sharing_access_type)}),o=g.Viewer.get_viewer().get_user_by_id(this.props.user.id);s.push(new f.UserInfo(this.props.user.account_id,o.display_name,!0,!0,r,o.email,void 0,void 0,o.photo_url))}else e=t;var i=this.partitionUserInfoLists(e),a=i.newPresentUserInfoList,p=i.presentUserInfoList,u=i.anonymousUserInfoList,l=i.offlineUserInfoList,c=i.neverViewedUserInfoList;return p.sort(function(e,s){return e.displayName.toLowerCase().localeCompare(s.displayName.toLowerCase())}),c.sort(function(e,s){return e.displayName.toLowerCase().localeCompare(s.displayName.toLowerCase())}),s.concat(a,p,u,l,c)},s.prototype.isNewPresentUser=function(e){return this.state.newPresentUserIds.indexOf(e.key)>=0},s.prototype.getMergedSeenStateData=function(){var e=this.getSeenStates(),s=e.map(function(e){return e.seen_state_user.user_id});if(this.props.sharingStorePassInfo.data){for(var t=0,n=this.props.sharingStorePassInfo.data.users;t<n.length;t++){var r=n[t],o=r.seen_state_user.user_id;s.indexOf(o)!==-1||o===this.props.user.account_id&&this.shouldHardcodeCurrentViewer()||e.push(r)}return e.concat(this.props.anonymousPresenceInfo,this.props.sharingStorePassInfo.data.invitees)}return e.concat(this.props.anonymousPresenceInfo)},s.prototype.shouldHardcodeCurrentViewer=function(){var e=!(g.Viewer.get_viewer().is_assume_user_session||this.props.fromBrowse),s=null!=this.props.presence&&this.props.presence.indexOf(this.props.user.account_id)>=0;return e||s},s.prototype.getSeenStates=function(){return this.props.identifiedSeenStateInfo&&this.props.identifiedSeenStateInfo.seen_states?this.props.identifiedSeenStateInfo.seen_states.slice():[]},s.prototype.haveSeenStateDataToShow=function(e){var s=e.length;return s>=2||1===s&&e[0].key!==this.props.user.account_id},s.prototype.allDataHasLoaded=function(){return h.fetchingStatusSeenStateIsComplete(this.props.passFetchingStatus)&&this.props.sharingStorePassInfo.isLoaded&&this.props.uniqueMemberCountInfo.isLoaded},s.prototype.render=function(){if(this.props.isPassPermissionsPending||this.props.passFetchingStatus===h.PASS_FETCHING_STATUS.ERROR||null==this.props.passPermissions||!this.props.passPermissions.canReadPresence&&!this.props.passPermissions.canReadSeenState)return this.renderEmptyFacepile();if(!this.allDataHasLoaded())return this.props.fromBrowse?r.default.createElement(a.LoadingIndicator,{style:a.LoadingIndicator.LoadingIndicatorStyle.DOTS}):r.default.createElement("div",null);var e=this.getUserInfoList();if(this.numUsersToLog=e.length,this.haveSeenStateDataToShow(e)){this.props.isCollapsed&&(e=e.slice(0,1));var s=this.computeOverflowBasis(e);return r.default.createElement("div",{className:this.facepileClassName()},r.default.createElement(E.RichFacepile,{sizeClass:this.getConvertedSizeClass(),doNullRenderIfSmall:!0,avatarInfoList:this.computeAvatarInfos(e),localization:this.localization,onTooltipChange:this.onTooltipChange,overflowBasis:s,tooltipComponent:E.UtilTooltip}))}return this.renderEmptyFacepile()},s.prototype.getConvertedSizeClass=function(){switch(this.props.sizeClass){case S.SizeClass.Small:return E.SizeClass.Small;case S.SizeClass.Medium:return E.SizeClass.Medium;case S.SizeClass.Large:case S.SizeClass.ExtraLarge:return E.SizeClass.Large}},s.prototype.renderEmptyFacepile=function(){return r.default.createElement(l.EmptySeenStateFacepile,{hasPresence:null!=this.props.presence})},s.prototype.facepileClassName=function(){var e;return n.default((e={},e[h.FACEPILE_CLASSNAME]=!0,e[h.PRESENCE_RECEIVED_CLASSNAME]=null!=this.props.presence,e))},s.prototype.computeAvatarInfos=function(e){var s=this;return e.slice(0,E.MAX_FACES).map(function(e){var t=e.isActive,n=e.displayName,o=e.key,i=e.userId,a=e.photoUrl;return{present:t,displayName:n,initials:w.getInitials(n),memberKey:o,photoUrl:a||null,passiveTooltipContent:r.default.createElement(m.UserAvatarPassiveTooltipContent,{userInfo:e,integrationStore:s.context.getIntegrationStore()}),userId:i}})},s.contextTypes={getIntegrationStore:o.func},s})(r.default.Component);s.SeenStateFacepileComponentSpectrumized=C,s.SeenStateFacepileSpectrumized=u.requireCssWithComponent(C,["/static/css/seen_state_facepile-vflT5h6WI.css","/static/js/deep-integrations/index.web-vflzwc4Bp.css"])});
//# sourceMappingURL=seen_state_facepile_spectrumized.min.js-vfl0Xe1mO.map